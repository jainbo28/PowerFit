#!/usr/bin/env node
const path = require('path');
const fs = require('fs-extra');
const { APP_ROOT_DIR, COMMAND } = require('../consts');

/**
 * @command init - Initialize the project structure.
 * @command app <app_anme> - Generate a new application
 * @command serve - Run a local server for testing.
 */


runCommand( COMMAND );

function init()
{

    let force = process.argv.includes('--force');
    /// Copy necessary folders
    let folders = [
        'frontend/dist/apps/main',
        'frontend/dist/apps/notfound', 
        'frontend/dist/apps/auth/login', 
        'frontend/dist/apps/auth/registration', 
        'frontend/dist/core', 
        'frontend/dist/vendor/core/app.js',
        'frontend/dist/vendor/core/app.css',
        'frontend/dist/vendor/remixicon/remixicon.css', 
        'frontend/shared/layouts/default.ejs',
        'frontend/shared/layouts/auth.ejs',
        'frontend/shared/partials/footer.ejs',
        'frontend/shared/partials/header.ejs',
        'locals/template.js', 
        'routes/api.js',
        'middlewares/test.js', 
        'index.js'
    ];

    
    folders.forEach(_f=>{
        // Source and destination paths
        let sourcePath = path.join( path.dirname( __dirname ), `/defaults/${_f}`);
        let destinationPath = `${APP_ROOT_DIR}/${_f}`;

        // Use fs-extra to copy the folder
        if( fs.existsSync( destinationPath ) && !force ) {
            console.log(` ${ _f } - Exists!`);
        } else{
            fs.copy(sourcePath, destinationPath, (err) => {
                if (err) {
                    console.error(`error copying - ${ _f } `, err);
                } else {
                    console.log(` ${ _f } - successfully copied!`);
                }
            });
        }
    });
    
}


function generateApplication()
{
    let app_name = process.argv[3];
    
    let files = [
        { name:'index.ejs', content: `<h1> ${app_name} works!</h1>` },
        { name:'index.js', content: '// Your app JavaScript code.' },
        { name:'index.css', content: '/** Your app style. */' },
        { name:'config.json', content: JSON.stringify({ 
            "layout":"shared/layouts/default",
            "access":"public" 
        }) }
    ];
    if( fs.existsSync( `${APP_ROOT_DIR}/frontend/dist/apps/${app_name}` ) ){
        console.log(` App ${app_name} already exists!`);
    }else {
        files.forEach(_f=>{
            // Specify the file path
            const filePath = `${APP_ROOT_DIR}/frontend/dist/apps/${app_name}/${_f.name}`;
    
            // Using fs-extra's outputFile method to create the file
            fs.outputFile(filePath, _f.content, (err) => {
                if (err) {
                    console.error('Error creating file:', err);
                } else {
                    console.log('File created successfully!');
                }
            });
        })
    }

    
    
}

function serve()
{

}


function runCommand( p_command )
{
    switch( p_command )
    {
        case 'init':
            init()
            break;
        case 'app':
            generateApplication()
            break;
        case 'serve':
            serve()
            break;
        default:
            invalidCommand()
    }
}